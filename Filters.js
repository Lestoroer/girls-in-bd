

class Filters {
	constructor() {
		this.groups_black_list = {
			'28905875' : 1,
			'130277438' : 1,
			'126093223' : 1,
			'143926363' : 1,
			'31480508' : 1,
			'31480508' : 1,
			'88350989' : 1,
			'56106344' : 1,
			'34215577' : 1,
			'65539551' : 1,
			'74006511' : 1,
			'44781847' : 1,
			'51889526' : 1,
			'121785617' : 1,
			'29573241' : 1,
			'115026343' : 1,
			'52035408' : 1,
			'36227478' : 1,
			'24382072' : 1,
			'95470601' : 1,
			'114454317' : 1,
			'27794994' : 1,
			'31071893' : 1,
			'35179056' : 1,
			'23546772' : 1,
			'91050183' : 1,
			'11108956' : 1,
			'1415705' : 1,
			'123695926' : 1,
			'116826793' : 1,
			'30957440' : 1,
			'39733006' : 1,
			'46424681' : 1,
			'46275035' : 1,
			'14395935' : 1,
			'29773768' : 1,
			'46593573' : 1,
			'108860195' : 1,
			'28481418' : 1,
			'77963997' : 1,
			'75104505' : 1,
			'40400929' : 1,
			'114539266' : 1,
			'15911874' : 1,
			'21396707' : 1,
			'38296018' : 1,
			'1959' : 1,
			'25380626' : 1,
			'41774259' : 1,
			'48512305' : 1,
			'40367885' : 1,
			'18496184' : 1,
			'15829245' : 1,
			'16775977' : 1,
			'4579233' : 1,
			'51109251' : 1,
			'11064089' : 1,
			'28429027' : 1,
			'15380384' : 1,
			'25789863' : 1,
			'76709587' : 1,
			'135341281' : 1,
			'132178910' : 1,
			'109331971' : 1,
			'35762179' : 1,
			'29599237' : 1,
			'70053399' : 1,
			'51073679' : 1,
			'126205007' : 1,
			'152854540' : 1,
			'30318830' : 1,
			'29038248' : 1,
			'43600373' : 1,
			'27770786' : 1,
			'76665680' : 1,
			'117376484' : 1,
			'145257545' : 1,
			'92876084' : 1,
			'98906766' : 1,
			'134620125' : 1,
			'31234561' : 1,
			'43776215' : 1,
			'34215577' : 1,
			'93943373' : 1,
			'145080488' : 1,
			'41268624' : 1,
			'97414512' : 1,
			'36164349' : 1,
			'56427165' : 1,
			'94216909' : 1,
			'40618186' : 1,
			'12382740' : 1,
			'55093819' : 1,
			'67666032' : 1,
			'29686754' : 1,
			'77467403' : 1,
			'15326149' : 1,
			'34875089' : 1,
			'31613032' : 1,
			'40500796' : 1,
			'84301745' : 1,
			'66523083' : 1,
			'111135348' : 1,
			'129677174' : 1,
			'31836774' : 1,
			'23065273' : 1,
			'23243883' : 1,
			'112164970' : 1,
			'44185119' : 1,
			'122559935' : 1,
			'142931790' : 1,
			'142344720' : 1,
			'49337706' : 1,
			'40006231' : 1,
			'126196919' : 1,
			'133214144' : 1,
			'74375689' : 1,
			'114038183' : 1,
			'156022178' : 1,
			'59086790' : 1,
			'123861343' : 1,
			'131208627' : 1,
			'19610854' : 1,
			'11353891' : 1,
			'130898973' : 1,
			'132293269' : 1,
			'97601902' : 1,
			'145566661' : 1,
			'46855773' : 1,
			'52660216' : 1,
			'145837755' : 1,
			'52155502' : 1,
			'97632120' : 1,
			'30655967' : 1,
			'81389769' : 1,
			'39279233' : 1,
			'48555158' : 1,
			'150462449' : 1,
			'135703375': 1,
			'147397957' : 1,
			'45441631' : 1,
			'23064236' : 1,
			'22741624' : 1,
			'25554967' : 1,
			'33770645' : 1,
			'34491673' : 1,
			'30008385' : 1,
			'44786979' : 1,
			'30532220' : 1,
			'138880351' : 1,
			'61052294' : 1,
			'29435908' : 1,
			'74889711' : 1,
			'21515884' : 1,
			'28546855' : 1,
			'83729091' : 1,
			'83556334' : 1,
			'33708813' : 1,
			'26419239' : 1,
			'111615879' : 1,
			'76907092' : 1,
			'127211280' : 1,
			'60446800' : 1,
			'46946905' : 1,
			'77822993' : 1,
			'52432716' : 1,
			'55795183' : 1,
			'46466345' : 1,
			'126264371' : 1,
			'124921653' : 1,
			'38444282' : 1,
			'119907945' : 1,
			'64582191' : 1,
			'48509637' : 1,
			'123757431' : 1,
			'78380693' : 1,
			'114396220' : 1,
			'47297979' : 1,
			'64774372' : 1,
			'113006162' : 1,
			'126100310' : 1,
			'24089576' : 1,
			'97385648' : 1,
			'150709625' : 1,
			'112383158' : 1,
			'61088527' : 1,
			'82710420' : 1,
			'22866546' : 1,
			'26515827' : 1,
			'50382470' : 1,
			'23984082' : 1,
			'183079' : 1,
			'33089990' : 1,
			'64848953' : 1,
			'66596121' : 1,
			'24180516' : 1,
			'12382740' : 1,
			'127659074' : 1,
			'39075890' : 1,
			'122372464' : 1,
			'27605011' : 1,
			'61231379' : 1,
			'1946517' : 1,
			'13208091' : 1,
			'34563153' : 1,
			'23180464' : 1,
			'90297478' : 1,
			'136474608' : 1,
			'150744997' : 1,
			'49216920' : 1,
			'73776762' : 1,
			'148278045' : 1,
			'45595714' : 1,
			'120491730' : 1,
			'27972579' : 1,
			'29345042' : 1,
			'128219403' : 1,
			'102884967' : 1,
			'62321972' : 1,
			'90656739' : 1,
			'103174100' : 1,
			'51189706' : 1,
			'58170807' : 1,
			'27895931' : 1,
			'31713884' : 1,
			'72199240' : 1,
			'58170807' : 1,
			'63827801' : 1,
			'61061413' : 1,
			'102022158' : 1,
			'102585210' : 1,
			'66678575' : 1,
			'138718885' : 1,
			'137360193' : 1,
			'73598440' : 1,
			'113259278' : 1,
			'111020126' : 1,
			'88522119' : 1,
			'62418732' : 1,
			'149787066' : 1,
			'77755920' : 1,
			'460389' : 1,
			'72356844' : 1,
			'29832607' : 1,
			'35699624' : 1,
			'47220519' : 1,
			'126100569' : 1,
			'35758136' : 1,
			'109529547' : 1,
			'147048985' : 1,
			'60717431' : 1,
			'33667151' : 1,
			'28627911' : 1,
			'36318299' : 1,
			'147845620' : 1,
			'141337755' : 1,
			'99800886' : 1,
			'57444895' : 1,
			'23482487' : 1,
			'29178527' : 1,
			'28981879' : 1,
			'34816652' : 1,
			'47215686' : 1,
			'59120170' : 1,
			'150174140' : 1,
			'145800770' : 1,
			'1429820' : 1,
			'145702535' : 1,
			'124254828' : 1,
			'113086748' : 1,
			'383476' : 1,
			'42981815' : 1,
			'152046864' : 1,
			'24628179' : 1,
			'18724321' : 1,
			'70634941' : 1,
			'45085246' : 1,
			'23911394' : 1,
			'98653861' : 1,
			'29892348' : 1,
			'11428484' : 1,
			'38168721' : 1,
			'18284075' : 1,
			'22186156' : 1,
			'52537634' : 1,
			'69275738' : 1,
			'36456939' : 1,
			'48418728' : 1,
			'77843142' : 1,
			'83957971' : 1,
			'43232168' : 1,
			'59270032' : 1,
			'37678696' : 1,
			'153937002' : 1,
			'126100310' : 1,
			'147710263' : 1,
			'91916312' : 1,
			'142201749' : 1,
			'107804423' : 1,
			'75541268' : 1,
			'71223277' : 1,
			'29544671' : 1,
			'41035449' : 1,
			'128059231' : 1,
			'57052542' : 1,
			'84457696' : 1,
			'67083068' : 1,
			'32015300' : 1,
			'131568455' : 1,
			'24483645' : 1,
			'49583292' : 1,
			'65960786' : 1,
			'127661835' : 1,
			'49439086' : 1,
			'39410028' : 1,
			'42574198' : 1,
			'67486633' : 1,
			'33414947' : 1,
			'45259519' : 1,
			'29246653' : 1,
			'24036559' : 1,
			'73655376' : 1,
			'39371288' : 1,
			'57846937' : 1,
			'23148107' : 1,
			'25670128' : 1,
			'22735599' : 1,
			'84032162' : 1,
			'125880369' : 1,
			'50138149' : 1,
			'275205' : 1,
			'21082539' : 1,
			'72614618' : 1,
			'28423507' : 1,
			'32262071' : 1,
			'37466869' : 1,
			'110012789' : 1,
			'79541650' : 1,
			'41522980' : 1,
			'26669118' : 1,
			'120977669' : 1,
			'92025099' : 1,
			'125761174' : 1,
			'47776175' : 1,
			'40181548' : 1,
			'40070457' : 1,
			'52350816' : 1,
			'27243668' : 1,
			'35052228' : 1,
			'35544729' : 1,
			'35176474' : 1,
			'34528216' : 1,
			'33755055' : 1,
			'36085261' : 1,
			'32939817' : 1,
			'32477579' : 1,
			'44589158' : 1,
			'63234703' : 1,
			'85650256' : 1,
			'119654438' : 1,
			'36784394' : 1,
			'73562368' : 1,
			'71555314' : 1,
			'148018091' : 1,
			'90881235' : 1,
			'42144182' : 1,
			'65824359' : 1,
			'24390680' : 1,
			'' : 1,
			'' : 1,
			'' : 1,
			'' : 1,

		}
		this.groups_white_list = {
			'31480508' : 1,
		}
		// Настройки запросов
		this.parameters = { 
            'fields' : `sex,last_seen,relation,country,bdate,city,followers_count,home_town,can_write_private_message`,
            'search_sex' : 1,
            'city' : 2, // 1 Москва, 2 Санкт-Петербург, 106 Оренбург
            'min_age_to' : 17, // М
            'max_age_to' : 23,
            'search_has_photo' : 1
        }
	}

	filterUsers(users, age_from) {
		let users_array = [];
		for (let i = 0; i < users.length; i++) {
			if (this.checkUserAvailable(users[i])) {
				users[i].age = age_from; // Добавляем возраст
				users_array.push(users[i]);
			}
		}
		return users_array;
	}

	filterSubscriptions(groups, users) {
		if (this.checkSubscriptionGroupsAvailable(groups) ||
			this.checkSubscriptionUsersAvailable(users)) return null;
		return true;
		// let subscriptions_array = [];
		// for (let i = 0; i < subscriptions.length; i++) {
		// 	if (this.checkSubscriptionAvailable(subscriptions[i])) {
		// 		subscriptions_array.push(subscriptions[i]);
		// 	}
		// }
		// return subscriptions_array;
	}

	checkSubscriptionUsersAvailable (users) {
		if (users.count > 170) return false;
		return true;
	}

	checkSubscriptionGroupsAvailable(groups) {
		if (groups.count > 90) return false;
		for (let i = 0; i < groups.items.length; i++) {
			if (this.groups_black_list[groups.items[i]]) return false;
		}
		return true;
	}

	checkUserAvailable(user) {
		if (user['sex'] && user['sex'] == 2 ||
			user['deactivated'] ||
			user['last_seen'] && +user['last_seen']['time'] < Date.now()/1000 - 3 * 24 * 3600 ||
			!user['can_write_private_message'] ||
			!this.checkRelation(user) //||
			//!this.checkSityAndTown(user)
			) //|| 
		{
			return false;
		}
		return true;
	}

	checkRelation(user) {
		if ([2,3,4,5,7,8].indexOf(user['relation']) != -1) return false;
		return true;
	}

	checkSityAndTown(user) {
		if (user['city'] == this.parameters.city) return true;
		if (!user['home_town']) return false;
		let towns = `Спб, Питер, Санкт-петербург, СанктПетербург,
					 Saint, Петербург, Петроград, Ленинград, ПЕТЕРБУРГ,
					 saint-petersburg, saint petersburg`;
		let regExp = new RegExp(this.escapeRegExp(user['home_town']), 'i');
		if (regExp.test(towns)) return true;
		return false;
	}

	checkLvl(user) {
		if (user['bdate'] && user['bdate'].split('.').length == 3) {
			let year = +user['bdate'].split('.')[2];
			if (year > 1994 && year < 1998) return true;
			return false;
		}
		return false;
	}

	checkUserByBlackList(groups) {
		let black_mark = 0;
		for (let i = 0; i < groups.length; i++) {
			if (this.groups_black_list[groups[i]]) {
				if (i < 5) black_mark += 3;
				else if (i > 5 && i < 10) black_mark += 2;
				else black_mark += 1;
			}
		}
		return (black_mark < Math.ceil(groups.length * 0.017));
	}

	escapeRegExp(str) {
  		return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
	}
}

const filters = new Filters();
module.exports = filters;